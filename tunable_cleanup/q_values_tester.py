# -*- coding: utf-8 -*-
"""
Created on Thu Jul  9 09:07:50 2020

Author: David O'Callaghan
"""

import numpy as np
import random
import matplotlib.pyplot as plt

import tensorflow as tf
import sys
from datetime import datetime # Used for timing script

from collections import deque # Used for replay buffer and reward tracking

from so_cleanup import DQNAgent, env, FRAME_STACK_SIZE, N_AGENT

PATH_DIR = "./models/"

MODEL_PATHS = [f'{PATH_DIR}/cleanup_model_dqn1_single_2021-3-31_16_38.h5',
               f'{PATH_DIR}/cleanup_model_dqn2_single_2021-3-31_16_38.h5']

now = datetime.now()
date_and_time = f'{now.year}-{now.month}-{now.day}_{now.hour}_{now.minute}'

AGENT1_INITIAL_STATE = [
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [159, 67,255], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  2, 81,154], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]]
]

AGENT2_INITIAL_STATE = [
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [159, 67,255], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  2, 81,154], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0]],
    [[180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180]]
]

AGENT1_APPLE_STATE = [
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [159, 67,255], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  2, 81,154], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]]
]

AGENT2_APPLE_STATE = [
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [159, 67,255], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  2, 81,154], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [ 99,156,194], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[113, 75, 24], [113, 75, 24], [113, 75, 24], [113, 75, 24], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  0,  0], [  0,  255,  0], [  0,  255,  0]],
    [[180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180], [180,180,180]]
]

sys.stdout = sys.__stdout__

EPISODES = 1000

if __name__ == '__main__':

    np.random.seed(42)
    tf.random.set_seed(42)
    random.seed(42)

    # Initialise agents
    agent1 = DQNAgent(1)
    agent2 = DQNAgent(2)

    agent1.load_model(MODEL_PATHS[0])
    agent2.load_model(MODEL_PATHS[1])

    results = []
    steps = 0

    eps = 0.01
    #
    # # Reset env
    agent1_state = AGENT1_INITIAL_STATE
    agent2_state = AGENT2_INITIAL_STATE

    # Create deque for storing stack of N frames
    # Agent 1
    agent1_initial_stack = [agent1_state for _ in range(FRAME_STACK_SIZE)]
    agent1_frame_stack = deque(agent1_initial_stack, maxlen=FRAME_STACK_SIZE)
    agent1_state = np.concatenate(agent1_frame_stack, axis=2) # State is now a stack of frames
    # # Agent 2
    agent2_initial_stack = [agent2_state for _ in range(FRAME_STACK_SIZE)]
    agent2_frame_stack = deque(agent2_initial_stack, maxlen=FRAME_STACK_SIZE)
    agent2_state = np.concatenate(agent2_frame_stack, axis=2) # State is now a stack of frames

    # Get actions
    agent1_action = agent1.epsilon_greedy_policy(agent1_state, eps)
    agent2_action = agent2.epsilon_greedy_policy(agent2_state, eps)
    print(f"Agent 1 Action: {env.agents['agent-0'].action_map(agent1_action)}")
    print(f"Agent 2 Action: {env.agents['agent-1'].action_map(agent2_action)}")

    plt.cla()
    plt.imshow(AGENT1_INITIAL_STATE, interpolation='nearest')
    plt.savefig('./testing/' + date_and_time + 'agent1')

    plt.cla()
    plt.imshow(AGENT2_INITIAL_STATE, interpolation='nearest')
    plt.savefig('./testing/' + date_and_time + 'agent2')